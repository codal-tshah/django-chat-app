{% extends 'base.html' %}

{% block title %}Lobby - Django Chat{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
    <!-- Public Rooms -->
    <div class="card">
        <h2>Public Rooms</h2>
        <p style="color: var(--text-secondary);">Join a group conversation.</p>

        <div style="margin-bottom: 1rem;">
            <input type="text" id="newRoomInput" placeholder="Create or join a room...">
            <button onclick="joinRoom()" class="btn" style="margin-top: 0.5rem; width: 100%;">Join Room</button>
        </div>

        <ul style="list-style: none; padding: 0;">
            {% for room in public_rooms %}
            <li style="margin-bottom: 0.5rem;">
                <a href="{% url 'groupRoomPage' room.name %}" class="btn btn-secondary"
                    style="display: flex; align-items: center; padding: 0.8rem; text-align: left; border-radius: 8px;">
                    <span
                        style="background: #e9edef; padding: 8px; border-radius: 50%; margin-right: 10px; color: #54656f;">#</span>
                    {{ room.name }}
                    {% if room.unread_count > 0 %}
                    <span
                        style="margin-left: auto; background: #25d366; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">
                        {{ room.unread_count }}
                    </span>
                    {% endif %}
                </a>
            </li>
            {% empty %}
            <li style="color: var(--text-secondary);">No active rooms. Create one!</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Users -->
    <div class="card">
        <h2>Online Users</h2>
        <p style="color: var(--text-secondary);">Start a private chat.</p>

        <ul style="list-style: none; padding: 0;">
            {% for u in users %}
            <li style="margin-bottom: 0.5rem;">
                <a href="{% url 'privateRoomPage' u.username %}" class="btn btn-secondary"
                    style="display: flex; align-items: center; padding: 0.8rem; text-align: left; border-radius: 8px;">
                    <span
                        style="background: #dfe3e5; padding: 8px; border-radius: 50%; margin-right: 10px; color: #54656f;">@</span>
                    {{ u.username }}
                    {% if u.unread_count > 0 %}
                    <span
                        style="margin-left: auto; background: #25d366; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">
                        {{ u.unread_count }}
                    </span>
                    {% endif %}
                </a>
            </li>
            {% empty %}
            <li style="color: var(--text-secondary);">No other users found.</li>
            {% endfor %}
        </ul>
    </div>
</div>

<script>
    function joinRoom() {
        const roomName = document.getElementById('newRoomInput').value.trim();
        if (roomName) {
            window.location.href = `/chat/group/${roomName}/`;
        }
    }

    document.getElementById('newRoomInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            joinRoom();
        }
    });

    // Real-time notifications
    const lobbySocket = new WebSocket('ws://' + window.location.host + '/ws/chat/lobby/');

    // Notification permission logic
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }

    lobbySocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        if (data.type === 'notification') {
            const currentUser = "{{ user.username }}";

            // Don't notify if I sent the message
            if (data.sender === currentUser) return;

            let shouldNotify = false;
            let notificationTitle = "";
            let notificationBody = data.message;

            if (data.room_type === 'private') {
                // Check if the notification is for me
                if (data.target_user === currentUser) {
                    const sender = data.sender;
                    updateBadge(`a[href*="/chat/private/${sender}"]`);
                    shouldNotify = true;
                    notificationTitle = `New message from ${sender}`;
                }
            } else if (data.room_type === 'group') {
                // For group chats, everyone in the lobby gets notified
                const roomName = data.room_name;
                updateBadge(`a[href*="/chat/group/${roomName}"]`);
                shouldNotify = true;
                notificationTitle = `New message in #${roomName}`;
                notificationBody = `${data.sender}: ${data.message}`;
            }

            // Trigger Desktop Notification
            if (shouldNotify && !document.hasFocus()) {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(notificationTitle, {
                        body: notificationBody,
                        icon: 'https://cdn-icons-png.flaticon.com/512/733/733585.png',
                        tag: 'chat-notification'
                    });
                }
            }
        }
    };

    function updateBadge(selector) {
        const links = document.querySelectorAll(selector);
        links.forEach(link => {
            let badge = link.querySelector('.badge');
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'badge';
                badge.style.cssText = 'margin-left: auto; background: #25d366; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;';
                link.appendChild(badge);
                badge.textContent = 0;
            }
            // Increment count
            let count = parseInt(badge.textContent);
            badge.textContent = count + 1;
        });
    }
</script>
{% endblock %}